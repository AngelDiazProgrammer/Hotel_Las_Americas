<div th:fragment="vistaReservas" id="reservas-container">

    <!-- Mensajes Flash -->
    <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
        <span th:text="${success}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- Header con Bot√≥n Agregar -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
        <h1>üóìÔ∏è Gesti√≥n de Reservas</h1>
        <div class="d-flex align-items-center gap-2">
            <span class="badge bg-primary">
                Total: <span th:text="${totalReservas}">0</span> Reservas
            </span>
            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalCrearReserva">
                <i class="fas fa-plus me-1"></i> Nueva Reserva
            </button>
        </div>
    </div>

    <!-- Tabla -->
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-calendar-check me-2"></i>
                Lista de Reservas
            </h5>
            <small id="estadisticas" class="fst-italic"></small>
        </div>

        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                    <tr>
                        <th>Reserva</th>
                        <th>Hu√©sped</th>
                        <th>Habitaci√≥n</th>
                        <th>Entrada</th>
                        <th>Salida</th>
                        <th>Estado</th>
                        <th>Total Estimado</th>
                        <th>Acciones</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="reserva, stat : ${reservas}">
                        <td th:text="${reserva.idReserva}">1</td>
                        <td>
                            <strong th:text="${reserva.huesped?.nombre + ' ' + reserva.huesped?.apellido ?: 'N/A'}"></strong>
                        </td>
                        <td th:text="${reserva.habitacion?.numeroHabitacion ?: 'N/A'}"></td>
                        <td th:text="${reserva.fechaEntrada}"></td>
                        <td th:text="${reserva.fechaSalida}"></td>
                        <td>
                            <span th:switch="${reserva.estadoReserva?.idEstadoReserva}">
                                <span th:case="1" class="badge bg-warning">Pendiente</span>
                                <span th:case="2" class="badge bg-success">Confirmada</span>
                                <span th:case="3" class="badge bg-primary">Check-In</span>
                                <span th:case="4" class="badge bg-danger">Cancelada</span>
                                <span th:case="*" class="badge bg-secondary">Sin Estado</span>
                            </span>
                        </td>
                        <td th:text="${reserva.totalEstimado}"></td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-primary btn-editar-reserva"
                                        th:data-id="${reserva.idReserva}" data-bs-toggle="modal"
                                        data-bs-target="#modalEditarReserva" title="Editar Reserva">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button" class="btn btn-outline-info btn-ver-detalle-reserva"
                                        th:data-id="${reserva.idReserva}" data-bs-toggle="modal"
                                        data-bs-target="#modalVerDetalleReserva" title="Ver Detalle">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button type="button" class="btn btn-outline-danger btn-eliminar-reserva"
                                        th:data-id="${reserva.idReserva}" data-bs-toggle="modal"
                                        data-bs-target="#modalEliminarReserva" title="Eliminar Reserva">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div th:if="${reservas.size() == 0}" class="text-center py-4">
                <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No hay reservas registradas</h5>
                <p class="text-muted">Agrega algunas reservas para comenzar.</p>
            </div>


            <nav th:if="${totalPaginas > 1}" class="mt-3">
                <ul class="pagination justify-content-center">
                    <li class="page-item" th:classappend="${paginaActual == 0} ? 'disabled'">
                        <a class="page-link" href="javascript:void(0);"
                           th:onclick="'cargarComponenteConPagina(\'reservas\', ' + (${paginaActual} - 1) + ')'">
                            Anterior
                        </a>
                    </li>

                    <li class="page-item"
                        th:each="i : ${#numbers.sequence(0, totalPaginas - 1)}"
                        th:classappend="${i == paginaActual} ? 'active'">
                        <a class="page-link" href="javascript:void(0);"
                           th:text="${i + 1}"
                           th:onclick="'cargarComponenteConPagina(\'reservas\', ' + ${i} + ')'">
                        </a>
                    </li>

                    <li class="page-item" th:classappend="${paginaActual + 1 == totalPaginas} ? 'disabled'">
                        <a class="page-link" href="javascript:void(0);"
                           th:onclick="'cargarComponenteConPagina(\'reservas\', ' + (${paginaActual} + 1) + ')'">
                            Siguiente
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>

    <!-- ========== MODALES ========== -->

    <script type="text/javascript">
        if (typeof inicializarReservas === 'function') {
            inicializarReservas();
        }
    </script>

    <div class="modal fade" id="modalCrearReserva" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-plus-circle me-2"></i>Nueva Reserva
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>

                <form id="formCrearReserva"
                      th:action="@{/vistas/api/reservas}"
                      th:object="${nuevaReserva}"
                      method="post"
                      onsubmit="event.preventDefault(); crearReservaAJAX();">

                    <div class="modal-body">
                        <div class="row g-3">

                            <div class="col-md-6">
                                <label for="huesped" class="form-label">Hu√©sped (Selecci√≥n) *</label>
                                <select id="huesped" class="form-select" th:field="*{huesped}" required>
                                    <option value="">-- Seleccionar Hu√©sped --</option>
                                    <option
                                            th:each="huesped : ${listaHuespedes}"
                                            th:value="${huesped.idHuesped}"
                                            th:text="|${huesped.nombre} ${huesped.apellido} (Doc: ${huesped.documento})|">
                                    </option>
                                </select>
                            </div>

                            <div class="col-md-6">
                                <label for="habitacion" class="form-label">Habitaci√≥n *</label>
                                <select id="habitacion" class="form-select" th:field="*{habitacion}" required>
                                    <option value="">-- Seleccionar Habitaci√≥n --</option>
                                    <option
                                            th:each="habitacion : ${listaHabitaciones}"
                                            th:value="${habitacion.idHabitacion}"
                                            th:data-precio="${habitacion.precioNoche}"
                                            th:text="|Habitaci√≥n #${habitacion.numeroHabitacion} (Tipo: ${habitacion.tipoHabitacionId} - Capacidad : ${habitacion.capacidad} personas)|">
                                    </option>
                                </select>
                            </div>

                            <div class="col-md-6">
                                <label for="fechaEntrada" class="form-label">Fecha Entrada *</label>
                                <input type="date" id="fechaEntrada" class="form-control" th:field="*{fechaEntrada}" required>
                            </div>

                            <div class="col-md-6">
                                <label for="fechaSalida" class="form-label">Fecha Salida *</label>
                                <input type="date" id="fechaSalida" class="form-control" th:field="*{fechaSalida}" required>
                            </div>

                            <div class="col-md-6">
                                <label for="precioMostrado" class="form-label">Precio por Noche *</label>

                                <p class="form-control-plaintext" id="precioMostrado">
                                    150.000
                                </p>

                                <input type="hidden" id="totalEstimado" th:field="*{totalEstimado}">
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Estado Inicial *</label>
                                <select id="estadoReserva" class="form-select" th:field="*{estadoReserva}" required>
                                    <option value="">-- Seleccionar Estado --</option>
                                    <option
                                            th:each="estado : ${listaEstadosReserva}"
                                            th:value="${estado.idEstadoReserva}"
                                            th:text="|${estado.estado} (${estado.descripcion})|">
                                        Pendiente (Reserva pendiente de check-in)
                                    </option>
                                </select>
                            </div>

                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-success" id="btnCrearReserva">
                            <span id="btnCrearReservaTexto">Guardar Reserva</span>
                            <span id="btnCrearReservaSpinner" class="spinner-border spinner-border-sm"
                                  style="display:none;"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Modal Editar -->
<div class="modal fade" id="modalEditarReserva" tabindex="-1" aria-labelledby="modalEditarReservaLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalEditarReservaLabel">‚úèÔ∏è Editar Reserva #<span
                        id="reserva-id-editar"></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>
            <form id="formEditarReserva" onsubmit="event.preventDefault(); actualizarReservaAJAX(this);">
                <div class="modal-body" id="modal-body-editar">
                    <div class="text-center p-5">Cargando datos...</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="submit" class="btn btn-primary" id="btnGuardarEdicionReserva">
                        <span id="btnGuardarEdicionTexto">Guardar Cambios</span>
                        <span id="btnGuardarEdicionSpinner" class="spinner-border spinner-border-sm"
                              style="display:none;"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Ver Detalles -->
<div class="modal fade" id="modalVerDetalleReserva" tabindex="-1" aria-labelledby="modalVerDetalleReservaLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="modalVerDetalleReservaLabel">üëÅÔ∏è Detalle de Reserva #<span
                        id="reserva-id-detalle"></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modal-body-detalle">
                <div class="text-center p-5">Cargando datos...</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Eliminar -->
<div class="modal fade" id="modalEliminarReserva" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">üóëÔ∏è Confirmar Eliminaci√≥n</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="formEliminarReserva" onsubmit="event.preventDefault(); eliminarReservaAJAX(this);">
                <input type="hidden" name="idReservaEliminar" id="idReservaEliminar" value="">
                <div class="modal-body">
                    <div id="mensajeEliminarReserva" class="alert" style="display:none;"></div>
                    <p>¬øEst√° seguro que desea eliminar la reserva **#<span id="reserva-id-eliminar"></span>**?</p>
                    <p class="text-danger"><small>Esta acci√≥n es irreversible.</small></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger" id="btnConfirmarEliminacion">
                        <span id="btnConfirmarTexto">Eliminar</span>
                        <span id="btnConfirmarSpinner" class="spinner-border spinner-border-sm"
                              style="display:none;"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

</div>
<script>
    $(document).ready(function() {
        const $selectHabitacion = $('#habitacion');
        const $precioMostrado = $('#precioMostrado');
        const $totalEstimadoInput = $('#totalEstimado');

        // Funci√≥n para actualizar precio
        function mostrarPrecioPorNoche() {
            // Obtenemos el valor del option seleccionado
            const precioDiario = parseFloat($selectHabitacion.find('option:selected').attr('data-precio')) || 0;

            // Actualizar visual y input oculto
            $precioMostrado.text(precioDiario.toFixed(2));
            $totalEstimadoInput.val(precioDiario.toFixed(2));
        }

        // Ejecutar al cargar la p√°gina
        mostrarPrecioPorNoche();

        // Ejecutar cuando cambie la selecci√≥n
        $selectHabitacion.on('change', mostrarPrecioPorNoche);
    });


</script>